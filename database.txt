CREATE DATABASE vps_auth
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

USE vps_auth;
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,

    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NULL,
    full_name VARCHAR(255),
    avatar_url VARCHAR(512),

    status ENUM(
        'UNVERIFIED',
        'ACTIVE',
        'SUSPENDED',
        'BANNED'
    ) NOT NULL DEFAULT 'UNVERIFIED',

    is_suspicious BOOLEAN DEFAULT FALSE,

    provider ENUM('LOCAL', 'GOOGLE') DEFAULT 'LOCAL',
    provider_id VARCHAR(255) NULL,

    email_verified_at TIMESTAMP NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_users_email (email),
    UNIQUE KEY uk_provider (provider, provider_id)
) ENGINE=InnoDB;
CREATE TABLE email_verification_tokens (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,

    token_hash VARCHAR(255) NOT NULL,
    expired_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_evt_user
        FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE CASCADE,

    INDEX idx_evt_user (user_id),
    INDEX idx_evt_token (token_hash)
) ENGINE=InnoDB;
CREATE TABLE sessions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,

    token_id VARCHAR(255) NOT NULL, -- jti trong JWT
    expired_at TIMESTAMP NOT NULL,
    revoked_at TIMESTAMP NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_sessions_user
        FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE CASCADE,

    UNIQUE KEY uk_token_id (token_id),
    INDEX idx_sessions_user (user_id),
    INDEX idx_sessions_expired (expired_at)
) ENGINE=InnoDB;
CREATE TABLE password_reset_otps (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,

    otp_hash VARCHAR(255) NOT NULL,
    expired_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP NULL,

    attempt_count INT DEFAULT 0,
    max_attempt INT DEFAULT 5,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_reset_user
        FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE CASCADE,

    INDEX idx_reset_user (user_id),
    INDEX idx_reset_expired (expired_at)
) ENGINE=InnoDB;
CREATE TABLE oauth_states (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,

    state VARCHAR(255) NOT NULL,
    provider ENUM('GOOGLE') NOT NULL,
    expired_at TIMESTAMP NOT NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uk_oauth_state (state)
) ENGINE=InnoDB;
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NULL,

    action VARCHAR(100) NOT NULL,
    ip_address VARCHAR(45),
    user_agent VARCHAR(255),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_audit_user (user_id),
    INDEX idx_audit_action (action),
    INDEX idx_audit_created (created_at)
) ENGINE=InnoDB;
